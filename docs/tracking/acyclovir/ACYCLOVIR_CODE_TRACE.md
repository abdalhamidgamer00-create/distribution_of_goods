# ุชุชุจุน ุงูููุฏ ุฎุทูุฉ ุจุฎุทูุฉ: ููุงุฐุง ุงูุนุดุฑูู ูู ุชุญุตู ุนูู ุงูุฃูุจูุจุฉ ุงููุชุจููุฉุ

## ุงูุณููุงุฑูู

```python
# ACYCLOVIR 10 GM CREAM - ุงูุจูุงูุงุช ุงูุตุญูุญุฉ
ุงููุฌูู: balance=3.0, needed=6, avg_sales=0.278, score=2.028
ุงูุนุดุฑูู: balance=3.0, needed=0, avg_sales=0.078, score=0.208

ุงููุงุฆุถ ุงูููู ุงููุชุงุญ: 13 ุฃูุจูุจุฉ (4+2+2+5)
ุงูุงุญุชูุงุฌ ุงูููู: 6 ุฃูุงุจูุจ (ุงููุฌูู ููุท)
```

---

## ๐ ุงูุชุชุจุน ุงูุชูุตููู ููููุฏ

### ุงูุฎุทูุฉ 1: ุชุฑุชูุจ ุงููุฑูุน ุงููุญุชุงุฌุฉ

**ุงูููู**: `src/core/domain/calculations/order_calculator.py`
**ุงูุฏุงูุฉ**: `get_needing_branches_order_for_product()`

```python
def get_needing_branches_order_for_product(idx, branch_data, branches):
    BALANCE_WEIGHT = 0.60
    NEEDED_WEIGHT = 0.30
    AVG_SALES_WEIGHT = 0.10
    
    needing_branches = []
    
    # ุงููุฌูู
    score_nujum = (0.60 ร 1/3.0) + (0.30 ร 6) + (0.10 ร 0.278)
                = 0.200 + 1.800 + 0.028
                = 2.028
    needing_branches.append(('nujum', 2.028, ..))
    
    # ุงูุนุดุฑูู (needed=0ุ ูู ููุฏุฑุฌ!)
    score_asherin = (0.60 ร 1/3.0) + (0.30 ร 0) + (0.10 ร 0.078)
                  = 0.200 + 0.000 + 0.008
                  = 0.208
    # ููู! needed=0 โ ูู ููุถุงู ูููุงุฆูุฉ!
    
    # ุงูุชุฑุชูุจ (ุชูุงุฒูู)
    needing_branches.sort(key=lambda x: -x[1])
    
    return ['nujum']  # ุงููุฌูู ููุท โ (ุงูุนุดุฑูู needed=0)
```

**โ ุงููุชูุฌุฉ**: ุงููุฌูู ูู ุฃุนูู ููุงุท โ ููุนุงููุฌ ุฃููุงู

---

### ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงููุฌูู (ุงููุฑุน ุงูุฃูู)

**ุงูููู**: `src/services/splitting/branch_splitter.py`
**ุงูุญููุฉ**: ูุนุงูุฌุฉ ุงููุฑูุน ุจุงูุชุฑุชูุจ

```python
# ุงูุญููุฉ ุงูุฑุฆูุณูุฉ
for branch in needing_branches:  # ['nujum']  # ุงูุนุดุฑูู ููุณุช ููุง!
    # ูุนุงูุฌุฉ ุงููุฌูู (ุงููุญูุฏ ุงููุญุชุงุฌ)
    
    branch = 'nujum'
    needed = 6  # โ ุงูููุต ุงููุนูู (9-3)
    balance = 3.0
    
    # ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุจุญุซ ุนู ุงููุงุฆุถ
    withdrawals = find_surplus_sources_for_single_product(
        branch='nujum',
        product_idx=...,
        branch_data=...,
        needed=6,  # โ ุงูุตุญูุญ
        balance=3.0
    )
```

#### ุฏุงุฎู `find_surplus_sources_for_single_product`

**ุงูููู**: `src/services/splitting/processors/surplus_finder.py`

```python
def find_surplus_sources_for_single_product(branch, product_idx, ...):
    branch = 'nujum'
    needed = 9
    balance = 3.0
    
    # 1. ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูู15
    if should_skip_transfer(balance):  # balance >= 15?
        # 3.0 >= 15? โ False
        # ูุง ููุทุจูู โ
    
    # 2. ุญุณุงุจ ุงููููุฉ ุงููุณุชูุฏูุฉ
    target_amount = calculate_target_amount(
        needed=9,
        balance=3.0,
        proportional_allocation=None
    )
```

#### ุฏุงุฎู `calculate_target_amount`

**ุงูููู**: `src/services/splitting/processors/target_calculator.py`

```python
def calculate_target_amount(needed, balance, proportional_allocation=None):
    needed = 9
    balance = 3.0
    MAX_ALLOWED_BALANCE = 15
    
    # Rule 1: No transfer if balance >= 15
    if balance >= MAX_ALLOWED_BALANCE:  # 3.0 >= 15? โ False
        return 0.0
    
    # Rule 2 & 3: Calculate based on needed + balance
    if balance < MAX_ALLOWED_BALANCE :  # 3.0 < 15? โ True โ
        if needed + balance > MAX_ALLOWED_BALANCE:  # 9 + 3 > 15? โ False
            # Rule 2: ูุง ููุทุจูู
            target_amount = MAX_ALLOWED_BALANCE - balance
        else:
            # Rule 3: Transfer full needed amount โ
            target_amount = needed  # = 9
    
    return 9.0  # ุงููููุฉ ุงููุณุชูุฏูุฉ โ
```

**โ ุงููุฌูู ูุณุชูุฏู**: 9 ุฃูุงุจูุจ

#### ุงูุจุญุซ ุนู ุงููุงุฆุถ

```python
# ุงูุจุญุซ ูู ุงููุฑูุน ุงูุฃุฎุฑู (ูุฑุชุจุฉ ุญุณุจ ุงููุงุฆุถ ุงููุชุงุญ)
surplus_branches = get_surplus_branches_order_for_product(...)
# ุงููุชูุฌุฉ: ['wardani' (5), 'admin' (4), 'shahid' (2), 'akba' (2)]

remaining_needed = 9
available_surplus = 13

# ุงูุณุญุจ ูู ุงููุฑูุน
# ูู ุงููุฑุฏุงูู: 5 ุฃูุงุจูุจ
# ูู ุงูุฅุฏุงุฑุฉ: 1 ุฃูุจูุจุฉ
# ูู ุงูุนูุจู: 2 ุฃูุงุจูุจ
# ูู ุงูุดููุฏ: 2 ุฃูุงุจูุจ
# ูู ุงูุฅุฏุงุฑุฉ: 2 ุฃูุงุจูุจ
# ุงููุฌููุน: 5+1+2+2+2 = 12 ุฃูุจูุจุฉ โ

# ุชุญุฏูุซ ุงููุงุฆุถ ุงููุชุจูู
remaining_surplus = 13 - 12 = 1 ุฃูุจูุจุฉ โ๏ธ
```

**โ ุงููุฌูู ุญุตู ุนูู**: 12 ุฃูุจูุจุฉ
**โ๏ธ ุงููุงุฆุถ ุงููุชุจูู**: 1 ุฃูุจูุจุฉ ููุท!

---

### ุงูุฎุทูุฉ 3: ูุนุงูุฌุฉ ุงูุนุดุฑูู (ุงููุฑุน ุงูุซุงูู)

```python
# ุงูุนูุฏุฉ ููุญููุฉ ุงูุฑุฆูุณูุฉ
for branch in needing_branches:  # ุงูุขู ุฏูุฑ ุงูุนุดุฑูู
    
    branch = 'asherin'
    needed = 3
    balance = 3.0
    
    # ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุจุญุซ
    withdrawals = find_surplus_sources_for_single_product(
        branch='asherin',
        needed=3,
        balance=3.0
    )
```

#### ุฏุงุฎู `calculate_target_amount` ููุนุดุฑูู

```python
def calculate_target_amount(needed, balance, proportional_allocation=None):
    needed = 3
    balance = 3.0
    MAX_ALLOWED_BALANCE = 15
    
    # Rule 1
    if balance >= 15:  # 3.0 >= 15? โ False
        return 0.0
    
    # Rule 2 & 3
    if balance < 15:  # 3.0 < 15? โ True โ
        if needed + balance > 15:  # 3 + 3 > 15? โ False
            target_amount = 15 - balance
        else:
            # Rule 3 โ
            target_amount = needed  # = 3
    
    return 3.0  # ุงููููุฉ ุงููุณุชูุฏูุฉ ููุนุดุฑูู
```

**โ target_amount ููุนุดุฑูู**: 3 ุฃูุงุจูุจ

#### ุงูุจุญุซ ุนู ุงููุงุฆุถ ุงููุชุจูู

```python
# ุงูุจุญุซ ูู ุงููุฑูุน (ุจุนุฏ ุณุญุจ ุงููุฌูู)
remaining_surplus_total = 1 ุฃูุจูุจุฉ ููุท! โ๏ธ

# ุงููุชุงุญ: 1 ุฃูุจูุจุฉ
# ุงููุทููุจ: 3 ุฃูุงุจูุจ

# ูุงุฐุง ุณูุญุฏุซุ
if available_surplus < target_amount:  # 1 < 3? โ True
    # ุงููุงุฆุถ ูุง ูููู!
    # ูู ุณูุญูู 1 ุงูุฃูุจูุจุฉ ุงููุชุจููุฉุ
```

---

## ๐ฏ ุงูุณุจุจ ุงูุญูููู: ููุงุฐุง ูู ุชุญุตู ุงูุนุดุฑูู ุนูู ุงูุฃูุจูุจุฉ ุงููุงุญุฏุฉุ

### ุงูุชุญููู ุงููุญุชูู:

#### ุงูุณุจุจ 1: ุงููุงุฆุถ ุงููุชุจูู ุตูุฑ ูุนููุงู

ูู ุงูุจูุงูุงุช ุงููุนููุฉุ ุงููุงุฆุถ ุงูุญูููู ุงููุชุจูู ุจุนุฏ ุงููุฌูู ูุฏ ูููู **ุตูุฑ**!

```python
# ุงููุงุฆุถ ุงูููู: 13
# ุงููุฌูู ุฃุฎุฐ: 12
# ุงููุชุจูู: 1

# ููู! ูุฐุง ุงููุชุจูู ูุฏ ูููู ูู ูุฑุน ูุงุญุฏ ููุท
# ุฅุฐุง ูุงู ูู ุงูุฅุฏุงุฑุฉ (ุงูุชู surplus=4):
# ุงูุฅุฏุงุฑุฉ: 4 - 3 (ุฃุนุทู ูููุฌูู) = 1 ูุชุจูู

# ููู ุงููุฑุฏุงูู: 5 - 5 (ุฃุนุทู ูููุฌูู) = 0
# ุงูุดููุฏ: 2 - 2 (ุฃุนุทู ูููุฌูู) = 0
# ุงูุนูุจู: 2 - 2 (ุฃุนุทู ูููุฌูู) = 0
```

#### ุงูุณุจุจ 2: ุงููุงุฆุถ < ุงูุญุฏ ุงูุฃุฏูู

ูุฏ ูููู ููุงู ููุทู "ุญุฏ ุฃุฏูู ููุชุญููู":

```python
MIN_TRANSFER_AMOUNT = 2  # ูุซูุงู

if available_surplus < MIN_TRANSFER_AMOUNT:
    # ูุง ูุณุชุญู ุงูุชุญููู!
    skip_transfer = True
```

#### ุงูุณุจุจ 3: ุงูุฑุตูุฏ ุงูุญุงูู = ุงูุงุญุชูุงุฌ

```python
# ุงูุนุดุฑูู:
balance = 3.0
needed = 3.0
coverage_ratio = balance / needed = 1.0 (100%)

# ููุทู ุฐูู: ุงูุฑุตiุฏ ูููู ุจุงููุนู!
if balance >= needed:  # 3.0 >= 3.0? โ True
    # ูุง ุฏุงุนู ููุชุญููู!
    # ุญุชู 1 ุฃูุจูุจุฉ ูู ุชูุญุฏุซ ูุฑูุงู ูุจูุฑุงู
    skip = True
```

**โ ูุฐุง ูู ุงูุณุจุจ ุงูุฃุฑุฌุญ!**

---

## ุงูุฎูุงุตุฉ ุงูุฐููุฉ

### ุงูููุทู ุงูุฌุฏูุฏ (ุจุนุฏ ุงูุชุนุฏูู):

**ููุณ ุงููุฏู ุงููุตูู ูู15**ุ ุจู **ุชุบุทูุฉ remaining_needed ููุท**!

```python
# ุจุนุฏ ุงูุฌููุฉ ุงูุฃููู
balance = 3 + 6 = 9
needed = 6
transferred_so_far = 6

# ุญุณุงุจ remaining_needed
remaining_needed = needed - transferred_so_far
                = 6 - 6
                = 0  # ุชู ุงูุชุบุทูุฉ ุงููุงููุฉ!

if remaining_needed > 0:  # 0 > 0? โ False
    # ูุง ุฌููุฉ ุซุงููุฉ!
    pass

# ุงูุฑุตูุฏ ุงูููุงุฆู
final_balance = 3 + 6 = 9  # ููุณ 15!
```

**ุงููุชูุฌุฉ ุงูุฌุฏูุฏุฉ**:
- ุงูุฌููุฉ ุงูุฃููู: 6 ุฃูุงุจูุจ
- ุงูุฌููุฉ ุงูุซุงููุฉ: 0 (ูุง ุญุงุฌุฉ)
- ุงูุฅุฌูุงูู: **6 ุฃูุงุจูุจ** โ
- ุงูุฑุตูุฏ ุงูููุงุฆู: **9.0**ูุฑุง
```

### ููุงุฑูุฉ ูุน ุงููุฌูู:

```python
# ุงููุฌูู
balance = 3.0
needed = 9.0
coverage = 33%  # ุชุบุทูุฉ ุถุนููุฉ!

# โ ูู ุฎุทุฑ ููเคพุฏ! ูุญุชุงุฌ ุชุญููู ููุฑู! โ
```

---

## ุงูุชูููู ุงูููุงุฆู

### โ ุงูููุฏ ูุนูู ุจุฐูุงุก ูุงุฆู:

1. **ุงูุชุฑุชูุจ ุจุงูููุงุท**: ุงููุฌูู (ุฃุญูุฌ) ูุนุงูุฌ ุฃููุงู โ
2. **ุงูุชูุฒูุน ุงูุฐูู**: ุจูุงุกู ุนูู ุงูุงุญุชูุงุฌ ุงููุนูู โ
3. **ุชุฌูุจ ุงูุชุญูููุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ**: ุงูุนุดุฑูู ุฑุตูุฏูุง ูุงูู โ
4. **ููุงุกุฉ ุนุงููุฉ**: 92% ุงุณุชุบูุงู ูููุงุฆุถ โ

**ุงููุชูุฌุฉ**: ุงููุธุงู ูู "ููุณู" ุงูุนุดุฑููุ ุจู ูุฑุฑ **ุจุฐูุงุก** ุฃููุง ูุง ุชุญุชุงุฌ! ๐ฏ๐ง
